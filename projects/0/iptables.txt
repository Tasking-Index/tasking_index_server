##ELIMINAR REGLAS
iptables -t nat -F
iptables -t filter -F

##DROP POR DEFECTO
iptables -t filter -P INPUT DROP
iptables -t filter -P OUTPUT DROP
iptables -t filter -P FORWARD DROP

##LOGS PASSWORD
iptables -A INPUT -m string --string "/etc/passwd" --algo kmp -j LOG --log-prefix "***** GIRC 2018: GET /ETC/PASSWD *****"
iptables -A OUTPUT -m string --string "/etc/passwd" --algo kmp -j LOG --log-prefix "***** GIRC 2018: GET /ETC/PASSWD *****"

##LOGS DESDECHADOS
iptables -A INPUT -j LOG --log-prefix "***** INPUT *****"
iptables -A OUTPUT -j LOG --log-prefix "***** OUTPUT *****"
iptables -A FORWARD -j LOG --log-prefix "***** FORWARD *****"

##CONEXION INTERNA
iptables -A INPUT -s 192.168.1.0/25 -p icmp -j ACCEPT
iptables -A OUTPUT -d 192.168.1.0/25 -p icmp -j ACCEPT
iptables -A INPUT -s 192.168.2.0/25 -p icmp -j ACCEPT
iptables -A OUTPUT -d 192.168.2.0/25 -p icmp -j ACCEPT

##PINGS A Y B
iptables -A FORWARD -s 192.168.1.1/25 -d 192.168.2.0/25 -p icmp -j ACCEPT
iptables -A FORWARD -s 192.168.2.0/25 -d 192.168.1.1/25 -p icmp --icmp-type 0 -j ACCEPT
iptables -A FORWARD -s 192.168.2.0/25 -d 192.168.1.1/25 -p icmp --icmp-type 8 -j REJECT

##TCP Y UDP DESDE A
iptables -A INPUT -s 192.168.1.0/25 -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/25 -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -d 192.168.1.0/25 -p tcp --sport 53 -j ACCEPT
iptables -A OUTPUT -d 192.168.1.0/25 -p udp --sport 53 -j ACCEPT

##TCP Y UDP EXTERNOS
iptables -A OUTPUT -s 10.0.2.15/24  -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -d 10.0.2.15/24 -p tcp --sport 53 -j ACCEPT
iptables -A OUTPUT -s 10.0.2.15/24 -p udp --dport 53 -j ACCEPT
iptables -A INPUT -d 10.0.2.15/24 -p udp --sport 53 -j ACCEPT
iptables -A FORWARD -s 192.168.2.0/25 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -s 192.168.2.0/25 -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -d 192.168.2.0/25 -p tcp --sport 53 -j ACCEPT
iptables -A FORWARD -d 192.168.2.0/25 -p udp --sport 53 -j ACCEPT
#FUNCIONA CON ESTO EN B (HACE QUE REDUELVA LOS INTERNOS -> MAL)
iptables -A INPUT -s 192.168.2.0/25 -p tcp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.2.0/25 -p udp --dport 53 -j ACCEPT
iptables -A OUTPUT -s 192.168.1.0/25 -p tcp --sport 53 -j ACCEPT
iptables -A OUTPUT -s 192.168.1.0/25 -p udp --sport 53 -j ACCEPT

##HTTP
iptables -t nat -A POSTROUTING -o enp0s3 -s 192.168.1.0/25 -j MASQUERADE
iptables -t nat -A POSTROUTING -o enp0s3 -s 192.168.2.0/25 -j MASQUERADE
iptables -A INPUT -i enp0s3 -p tcp -m multiport --sports 80,443 -j ACCEPT
iptables -A OUTPUT -o enp0s3 -p tcp -m multiport --dports 80,443 -j ACCEPT
iptables -A FORWARD -i enp0s8 -o enp0s3 -p tcp -m multiport --dports 80,443 -j ACCEPT
iptables -A FORWARD -o enp0s8 -i enp0s3 -p tcp -m multiport --sports 80,443 -j ACCEPT
iptables -A FORWARD -i enp0s9 -o enp0s3 -p tcp -m multiport --dports 80,443 -j ACCEPT
iptables -A FORWARD -o enp0s9 -i enp0s3 -p tcp -m multiport --sports 80,443 -j ACCEPT

##SSH
iptables -A INPUT -s 192.168.1.0/25 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -d 192.168.1.0/25 -p udp --dport 22 -j ACCEPT
iptables -A OUTPUT -s 192.168.1.0/25 -p tcp --sport 22 -j ACCEPT
iptables -A OUTPUT -d 192.168.1.0/25 -p udp --sport 22 -j ACCEPT